<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Cisco | Network-oriented programming]]></title>
  <link href="http://networkop.github.io/blog/categories/cisco/atom.xml" rel="self"/>
  <link href="http://networkop.github.io/"/>
  <updated>2016-03-21T03:56:14-07:00</updated>
  <id>http://networkop.github.io/</id>
  <author>
    <name><![CDATA[Michael Kashin]]></name>
    <email><![CDATA[mmkashin@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Network TDD Quickstart Guide]]></title>
    <link href="http://networkop.github.io/blog/2015/07/17/tdd-quickstart/"/>
    <updated>2015-07-17T00:00:00-07:00</updated>
    <id>http://networkop.github.io/blog/2015/07/17/tdd-quickstart</id>
    <content type="html"><![CDATA[<p>This post gives a quick overview of how to use network Test Driven Development framework. As an example I&rsquo;ll use a simplified version of a typical enterprise network with a Data Centre/HQ and a Branch office. A new branch is being added and the task is to configure routing for that branch using a TDD approach. First we&rsquo;ll devise a set of TDD scenarios to be tested and then, going through each one of them, modify routing to make sure those scenarios don&rsquo;t fail (a so-called red-green-refactor approach)</p>

<!--more-->


<h2>Network overview</h2>

<p>Let&rsquo;s assume you&rsquo;re working in a proverbial Acme Inc. It has a Data Centre hosting all centralised services and a single office branch (Branch #1). Sites are interconnected using active/backup WAN links. The company decides to expand and adds a new office in a city nearby. In additional to standard dual WAN links it&rsquo;s possible to buy a cheap and high throughput backdoor link between the two branches.</p>

<p><img class="centre" src="/images/tdd-big-topo.png" title="Acme Inc. Topology" ></p>

<h2>Network configuration</h2>

<p>Acme Inc. uses OSPF for intra-site routing and BGP for WAN routing. A standard configuration assumes that the core router at each site is the route reflector for the two WAN routers.</p>

<pre><code class="text CORE ROUTER CONFIG">interface Loopback0
 ip address 10.0.X.1 255.255.255.255
!
router ospf 100
 network 0.0.0.0 255.255.255.255 area 0
!
router bgp X
 bgp log-neighbor-changes
 timers bgp 1 5
 neighbor RR-CLIENTS peer-group
 neighbor RR-CLIENTS remote-as 1
 neighbor RR-CLIENTS update-source Loopback0
 neighbor RR-CLIENTS route-reflector-client
 neighbor 10.0.X.2 peer-group RR-CLIENTS
 neighbor 10.0.X.3 peer-group RR-CLIENTS
</code></pre>

<p>WAN routers originate site summary by first injecting their own Loopback IP address into BGP RIB and then aggregating it to site summary boundary (/24).</p>

<pre><code class="text WAN ROUTER 1 CONFIG">router ospf 100
 network 0.0.0.0 255.255.255.255 area 0
!
router bgp X
 bgp log-neighbor-changes
 network 10.0.X.2 mask 255.255.255.255
 aggregate-address 10.0.X.0 255.255.255.0
 neighbor &lt;PRIMARY_PE_IP&gt; remote-as &lt;PRIMARY_WAN_AS&gt;
 neighbor 10.0.X.1 remote-as 1
 neighbor 10.0.X.1 update-source Loopback0
</code></pre>

<p>No special path manipulation is done on either WAN routers by default.</p>

<pre><code class="text WAN ROUTER 2 CONFIG">router ospf 100
 network 0.0.0.0 255.255.255.255 area 0
!
router bgp X
 bgp log-neighbor-changes
 network 10.0.X.2 mask 255.255.255.255
 aggregate-address 10.0.X.0 255.255.255.0
 neighbor &lt;BACKUP_PE_IP&gt; remote-as &lt;BACKUP_WAN_AS&gt;
 neighbor 10.0.X.1 remote-as 1
 neighbor 10.0.X.1 update-source Loopback0
</code></pre>

<p>The same pattern is repeated on all sites with the exception of an additional backdoor link between the branch sites over which the two cores run eBGP. Inter-device transit subnets can be anything within the site-allocated range.</p>

<h2>Devising TDD scenarios</h2>

<p>After careful consideration of all links' bandwidths you devise a set of TDD scenarios and along with the high-level network topology present them to your management for endorsement. The idea is to always try to use the primary WAN link if possible. However for the inter-branch communication, backdoor link should be the preferred option. When the primary link fails at the new branch, all traffic to and from the DC should traverse the backdoor link only falling back to the secondary WAN link in case both primary and backdoor link fail. This corresponds to the 4 TDD scenarios (shown with coloured arrows on the above diagram):</p>

<p><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>./scenarios/all.txt </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>1. Testing of Primary Link (default scenario)&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;1.1 From DC-CORE to BR2-CORE via DC-WAN1,BR2-WAN1
</span><span class='line'>1.2 From BR2-CORE to DC-CORE via BR2-WAN1, DC-WAN1
</span><span class='line'>1.3 From BR2-WAN1 to BR1-WAN1 via BR2-CORE,BR1-CORE
</span><span class='line'>1.4 From BR1-WAN1 to BR2-WAN1 via BR1-CORE, BR2-CORE&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ol&gt;
</span><span class='line'>&lt;li&gt;Primary WAN failed at Branch #2&lt;/li&gt;
</span><span class='line'>&lt;/ol&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;2.1 From DC-CORE to BR2-CORE via DC-WAN1,BR1-WAN1,BR1-CORE
</span><span class='line'>2.2 From BR2-CORE to DC-CORE via BR1-CORE, BR1-WAN1, DC-WAN1
</span><span class='line'>2.3 From BR2-WAN2 to BR1-WAN2 via BR2-CORE, BR1-CORE
</span><span class='line'>2.4 From BR1-WAN2 to BR2-WAN2 via BR1-CORE, BR2-CORE&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ol&gt;
</span><span class='line'>&lt;li&gt;Backdoor link failed&lt;/li&gt;
</span><span class='line'>&lt;/ol&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;3.1 From BR2-WAN2 to BR1-WAN2 via BR2-WAN1, BR1-WAN1
</span><span class='line'>3.2 FROM BR1-WAN2 to BR2-WAN2 via BR1-WAN1, BR2-WAN1&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ol&gt;
</span><span class='line'>&lt;li&gt;Both Primary and Backdoor links failed at Branch #2&lt;/li&gt;
</span><span class='line'>&lt;/ol&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;4.1 From DC-CORE to BR2-CORE via DC-WAN2, BR2-WAN2
</span><span class='line'>4.2 From BR2-CORE to DC-CORE via BR2-WAN2, DC-WAN2
</span><span class='line'>4.3 From BR2-CORE to BR1-CORE via BR2-WAN2, BR1-WAN2
</span><span class='line'>4.4 From BR1-CORE to BR2-CORE via BR1-WAN2, BR2-WAN2
</span></code></pre></td></tr></table></div></figure></p>

<h2>Preparing the test environment</h2>

<p>First, you need to get a Linux machine connected to internet and to your network. A simply VM inside a VirtualBox would do. Now clone the git repository:
<code>bash Cloning git repository
git clone https://github.com/networkop/simple-cisco-tdd.git tdd-acme-inc
cd tdd-acme-int
</code>
Populate Ansible hosts inventory. In this case hosts are assigned to the group corresponding to their site and all the site groups are assigned to a parent group.
<figure class='code'><figcaption><span>./myhosts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>[dc-devices]
</span><span class='line'>DC-CORE ansible_ssh_host=10.0.1.1
</span><span class='line'>DC-WAN1 ansible_ssh_host=10.0.1.2
</span><span class='line'>DC-WAN2 ansible_ssh_host=10.0.1.3&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;[br1-devices]
</span><span class='line'>BR1-CORE ansible_ssh_host=10.0.2.1
</span><span class='line'>BR1-WAN1 ansible_ssh_host=10.0.2.2
</span><span class='line'>BR1-WAN2 ansible_ssh_host=10.0.2.3&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;[br2-devices]
</span><span class='line'>BR2-CORE ansible_ssh_host=10.0.3.1
</span><span class='line'>BR2-WAN1 ansible_ssh_host=10.0.3.2
</span><span class='line'>BR2-WAN2 ansible_ssh_host=10.0.3.3&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;[cisco-devices:children]
</span><span class='line'>dc-devices
</span><span class='line'>br1-devices
</span><span class='line'>br2-devices
</span></code></pre></td></tr></table></div></figure></p>

<p>Optionally, you can define your username/password credentials.</p>

<pre><code class="yaml ./group_vars/cisco-devices.yml">---
ansible_ssh_user: cisco
ansible_ssh_pass: cisco
</code></pre>

<p>Do the IP address information gathering and scenario processing first.
<code>bash Run the fact gathering
./ansible-playbook cisco-ip-collect.yml
</code></p>

<p>Verify that IP addresses and scenarios are now recorded in a global group variable file.
<code>bash Verify the content of all.yml file
cat ./group_vars/all.yml
</code></p>

<h2>Test the default scenario</h2>

<p>Now it&rsquo;s time to test. First, the default scenario:
<code>bash Testing scenario #1
ansible-playbook cisco_tdd.yml
Enter scenario number [1]: 1
...
skipping: [DC-WAN1]
skipping: [BR1-CORE]
skipping: [DC-WAN2]
skipping: [BR1-WAN2]
skipping: [BR2-WAN2]
ok: [BR2-CORE] =&gt; (item={'key': 'DC-CORE', 'value': ['BR2-WAN1', 'DC-WAN1']})
ok: [BR2-WAN1] =&gt; (item={'key': 'BR1-WAN1', 'value': ['BR2-CORE', 'BR1-CORE']})
ok: [BR1-WAN1] =&gt; (item={'key': 'BR2-WAN1', 'value': ['BR1-CORE', 'BR2-CORE']})
ok: [DC-CORE] =&gt; (item={'key': 'BR2-CORE', 'value': ['DC-WAN1', 'BR2-WAN1']})
</code></p>

<p>All tests succeeded.</p>

<h2>Testing the primary link failure</h2>

<p>Now, let&rsquo;s simulate the failure of a primary WAN link by shutting down the uplink on the WAN router:
<code>text BR2-WAN1
BR2-WAN1#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
BR2-WAN1(config)#int eth 0/0
BR2-WAN1(config-if)#shut
</code></p>

<p>And now run the second scenario:
<code>bash Testing scenario #2 - failed
ansible-playbook cisco_tdd.yml
Enter scenario number [1]: 2
...
failed: [DC-CORE] =&gt; (item={'key': 'BR2-CORE', 'value': ['DC-WAN1', 'BR1-WAN1']}) =&gt; {"failed": true, "item": {"key": "BR2-CORE", "value": ["DC-WAN1", "BR1-WAN1"]}}
msg: Failed scenario Primary WAN failed at Branch #2.
Traceroute from DC-CORE to BR2-CORE has not traversed ['DC-WAN1', 'BR1-WAN1']
 Actual path taken: DC-CORE -&gt; DC-WAN2 -&gt; 2.2.2.2 -&gt; BR2-WAN2 -&gt; BR2-CORE
ok: [BR1-WAN2] =&gt; (item={'key': 'BR2-WAN2', 'value': ['BR1-CORE', 'BR2-CORE']})
failed: [BR2-CORE] =&gt; (item={'key': 'DC-CORE', 'value': ['BR1-CORE', 'BR1-WAN1']}) =&gt; {"failed": true, "item": {"key": "DC-CORE", "value": ["BR1-CORE", "BR1-WAN1"]}}
msg: Failed scenario Primary WAN failed at Branch #2.
Traceroute from BR2-CORE to DC-CORE has not traversed ['BR1-CORE', 'BR1-WAN1']
 Actual path taken: BR2-CORE -&gt; BR2-WAN2 -&gt; 2.2.3.2 -&gt; DC-WAN2 -&gt; DC-CORE
ok: [BR2-WAN2] =&gt; (item={'key': 'BR1-WAN2', 'value': ['BR2-CORE', 'BR1-CORE']})
</code></p>

<p>Right, here is where it gets interesting. You see that the two scenarios have failed. Specifically traffic between the new branch and the DC has not traversed the backdoor link preferring the backup WAN instead. So we need to make the backup WAN less preferred. The easiest way is to use <code>as-path prepend</code> feature. Let&rsquo;s modify the configuration of our backup WAN router:</p>

<pre><code class="text BR2-WAN1">route-map RM-BGP-PREPEND-IN permit 10
 set as-path prepend last-as 4
route-map RM-BGP-PREPEND-OUT permit 10
 set as-path prepend 3 3 3 3
!
router bgp 3
neighbor 2.2.3.2 route-map RM-BGP-PREPEND-IN in
neighbor 2.2.3.2 route-map RM-BGP-PREPEND-OUT out
</code></pre>

<p>Now let&rsquo;s run the same test again:</p>

<pre><code class="bash Testing scenario #2 - success">ansible-playbook cisco_tdd.yml
Enter scenario number [1]: 2
ok: [DC-CORE] =&gt; (item={'key': 'BR2-CORE', 'value': ['DC-WAN1', 'BR1-WAN1']})
ok: [BR1-WAN2] =&gt; (item={'key': 'BR2-WAN2', 'value': ['BR1-CORE', 'BR2-CORE']})
ok: [BR2-CORE] =&gt; (item={'key': 'DC-CORE', 'value': ['BR1-CORE', 'BR1-WAN1']})
ok: [BR2-WAN2] =&gt; (item={'key': 'BR1-WAN2', 'value': ['BR2-CORE', 'BR1-CORE']})
</code></pre>

<p>Looks better now. Let&rsquo;s move on.</p>

<h2>Testing the Backdoor link failure</h2>

<p>Next in order, backdoor link failure. First let&rsquo;s restore our primary WAN link first:
<code>text BR2-WAN1
BR2-WAN1#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
BR2-WAN1(config)#int eth 0/0
BR2-WAN1(config-if)#no shut
</code></p>

<p>And bring down the link between the two branches:
<code>text BR2-CORE
BR2-CORE#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
BR2-CORE(config)#int eth 0/2
BR2-CORE(config-if)#shut
</code></p>

<p>Run the third scenario:
<code>bash Testing scenario #3
root@netops:~/quickstart# ansible-playbook cisco_tdd.yml
Enter scenario number [1]: 3
ok: [BR1-WAN2] =&gt; (item={'key': 'BR2-WAN2', 'value': ['BR1-WAN1', 'BR2-WAN1']})
ok: [BR2-WAN2] =&gt; (item={'key': 'BR1-WAN2', 'value': ['BR2-WAN1', 'BR1-WAN1']})
</code></p>

<p>Looking good. Now even the backup WAN routers traverse the primary WAN to talk to each other. Just as we expected.</p>

<h2>Testing of backup WAN</h2>

<p>Finally, let&rsquo;s see what would happen when both primary WAN and backdoor links go down. First, bring down the primary WAN link again:</p>

<pre><code class="text BR2-WAN1">BR2-WAN1#conf t
Enter configuration commands, one per line.  End with CNTL/Z.
BR2-WAN1(config)#int eth 0/0
BR2-WAN1(config-if)#shut
</code></pre>

<p>Run the last scenario:
<code>bash
ansible-playbook cisco_tdd.yml
Enter scenario number [1]: 4
ok: [DC-CORE] =&gt; (item={'key': 'BR2-CORE', 'value': ['DC-WAN2', 'BR2-WAN2']})
ok: [BR1-CORE] =&gt; (item={'key': 'BR2-CORE', 'value': ['BR1-WAN2', 'BR2-WAN2']})
ok: [BR2-CORE] =&gt; (item={'key': 'DC-CORE', 'value': ['BR2-WAN2', 'DC-WAN2']})
ok: [BR2-CORE] =&gt; (item={'key': 'BR1-CORE', 'value': ['BR2-WAN2', 'BR1-WAN2']})
</code></p>

<p>All tests passed. Now the network at the new branch is behaving exactly as we expect it to.</p>

<h2>Conclusion</h2>

<p>The above scenario, of course, is a gross simplification of a real life, however the demonstrated approach can be applied to varied network topologies. The desired state may be achieved through not one but several red-green-refactor cycles. The benefit of using this approach is not only confidence that you haven&rsquo;t broken anything by fixing one particular failure condition scenario, but also for future growth and development, when new devices are added or traffic flows are modified, these same tests can be re-run to ensure that the agreed assumptions still hold.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Verifying TDD Scenarios]]></title>
    <link href="http://networkop.github.io/blog/2015/07/10/test-verification/"/>
    <updated>2015-07-10T00:00:00-07:00</updated>
    <id>http://networkop.github.io/blog/2015/07/10/test-verification</id>
    <content type="html"><![CDATA[<p>Now that Ansible has done all the information gathering for us it&rsquo;s time to finally make use of it. In this post I will show how to use Ansible to run traceroutes from and to the hosts defined in a test scenario and perform verification of the results of those tests. Should any of those tests fail, Ansible will provide a meaningful description of what exactly failed and why. While doing all this I&rsquo;ll introduce a couple of new Ansible features like conditional looping and interactive prompts.</p>

<!--more-->


<h2>TDD Playbook</h2>

<p>In order to run and verify tests I will create a separate playbook. It makes sense to separate it from the <a href="http://networkop.github.io/blog/2015/07/03/parser-modules/">previous playbook</a> simply because this time it will be used multiple times, while the information gathering playbook can only be run once. The new playbook will have to accomplish the following tasks:</p>

<ol>
<li>Select which scenario to test</li>
<li>Run tests as specified in that scenario</li>
<li>Parse test results</li>
<li>Verify that test results conform to the specification</li>
</ol>


<h2>Selecting test scenario</h2>

<p>Our <code>scenarios/all.txt</code> file contains multiple test scenarios each defined by a name. Each test scenario represent a certain state in the network, e.g. scenario #1 tests how the network behaves in a normal state with no outages or link failures, scenario #2 tests how traffic should be rerouted in the event of primary link failure. Inside each scenario there are one or more test steps each testing a behaviour of a particular traffic flow, e.g. traffic from router R1 to router R4 should traverse R2 followed by R3. Each steps contains keywords <code>From</code>, <code>To</code> and <code>Via</code> which identify  source, destination and transit routers. This is how a typical scenario file looks like.</p>

<p><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/scenarios/all.txt </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>1. Testing of Primary Link
</span><span class='line'>1.1 From R1 to R3 via R2
</span><span class='line'>1.2 From R1 to R4 via R2, R3
</span><span class='line'>1.3 From R2 to R4 via R3
</span><span class='line'>1.4 From R1 to R2 via R2
</span><span class='line'>2. Testing of Backup Link
</span><span class='line'>2.1 From R1 to R3 via R4
</span><span class='line'>2.2 From R1 to R2 via R4,R3
</span></code></pre></td></tr></table></div></figure></p>

<p>In the <a href="http://networkop.github.io/blog/2015/07/03/parser-modules/">previous post</a> I showed how to parse and store these scenarios in YAML dictionary in <code>group_vars/all.yml</code> file, which makes this information automatically available to any future playbooks. So in the new playbook all we need to do is let the user decide which scenario to test:</p>

<p></p>

<h2>``` yaml ~/tdd_ansible/cisco_tdd.yml</h2>

<ul>
<li><p>name: Run traceroute commands
hosts: cisco-devices
gather_facts: false
remote_user: cisco</p>

<p>vars_prompt:</p>

<ul>
<li>name: scenario_num
prompt: &ldquo;Enter scenario number&rdquo;
default: &ldquo;1&rdquo;
private: no</li>
</ul>


<p>tasks:</p>

<ul>
<li>name: extracting scenario name and steps
set_fact:
  scenario_steps: &ldquo;{{ scenarios[scenario_num][1] }}&rdquo;
  scenario_name: &ldquo;{{ scenarios[scenario_num][0] }}&rdquo;
<figure class='code'><figcaption><span>./myhosts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;This playbook contains a standard header followed by a &lt;code&gt;vars_prompt&lt;/code&gt; section which prompts user to select a particular scenario number and stores the selection in &lt;code&gt;scenario_num&lt;/code&gt; variable. The first task in the playbook extracts scenario name and steps from &lt;code&gt;scenarios&lt;/code&gt; dictionary stored in &lt;code&gt;group_vars/all.yml&lt;/code&gt; file and stores them in respective variables. Of course this task is optional and it&amp;rsquo;s possible to reference the same data using full notation, however I prefer things to be more readable even if it leads to some inefficient memory use.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;Run test specified in scenario steps&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Now it&amp;rsquo;s time to run traceroutes to see how the packets flow in the network. As we did in one of the &lt;a href=&quot;http://networkop.github.io/blog/2015/06/24/ansible-intro/&quot;&gt;previous posts&lt;/a&gt; we&amp;rsquo;ll use the &lt;code&gt;raw&lt;/code&gt; module to run traceroutes. However this time, instead of running a full-mesh any-to-any traceroutes we&amp;rsquo;ll only run them if they were defined in one of the test steps. Indeed, why would we run a traceroute between devices if we&amp;rsquo;re not going to verify it? Ansible&amp;rsquo;s conditionals will help us with that. For each of the hosts in &lt;code&gt;cisco-devices&lt;/code&gt; group we&amp;rsquo;ll look into scenario_steps dictionary and see if there were any tests defined and if there were, we&amp;rsquo;ll run a traceroute to each of the destination hosts.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span><span class='line'>&lt;code&gt;yaml ~/tdd_ansible/cisco_tdd.yml
</span><span class='line'>    - name: run traceroutes as per the defined scenario steps
</span><span class='line'>      raw: traceroute {{ hostvars[item.key][&#39;ansible_ssh_host&#39;] }} source Loopback0 probe 1 numeric
</span><span class='line'>      when: scenario_steps[inventory_hostname] is defined
</span><span class='line'>      with_dict: scenario_steps[inventory_hostname]|default({})
</span><span class='line'>      register: trace_result
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;When both a loop (&lt;code&gt;with_dict&lt;/code&gt;) and a conditional (&lt;code&gt;when&lt;/code&gt;) are defined in a task, Ansible does the looping first. That&amp;rsquo;s why if a test scenario is not defined for a particular host (e.g. &lt;code&gt;R3&lt;/code&gt;) the conditional check will fail and stop execution of the playbook. To overcome that we can use Ansible (Jinja) templates inside the &lt;code&gt;with_dict&lt;/code&gt; loop. Appending &lt;code&gt;|default({})&lt;/code&gt; will instruct Ansible create an empty dictionary in case &lt;code&gt;scenario_steps[inventory_hostname]&lt;/code&gt; does not exist which will make conditional return &lt;code&gt;False&lt;/code&gt; and skip this host altogether.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;Parse test results&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;There&amp;rsquo;s no silver bullet when it comes to parsing of the outcome of traceroute command. We&amp;rsquo;ll have to use Python to traverse the textual output line by line looking for &lt;code&gt;msec&lt;/code&gt; and storing all found IPs in a list.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<div class='bogus-wrapper'><notextile><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/library/cisco_trace_parse.py </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">TraceParse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">pre</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">std_out</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;std_out&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;dest_host&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>\<span class="n">n</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="k">if</span> <span class="o">&amp;</span><span class="c">#39;msec&amp;#39; in line:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">pre</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="n">argument_spec</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">std_out</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">dest_host</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">traceParser</span> <span class="o">=</span> <span class="n">TraceParse</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">traceParser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ansible_facts</span><span class="o">=</span><span class="n">result</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">h1</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="kn">import</span> <span class="nn">module</span> <span class="nn">snippets</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">h1</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;The playbook task will run through each hosts&#39; trace_results variable and pass it to the trace parse module.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span><span class='line'>&lt;code&gt;yaml ~/tdd_ansible/cisco_tdd.yml
</span><span class='line'>    - name: parse traceroute ouput
</span><span class='line'>      cisco_trace_parse:
</span><span class='line'>        dest_host: &quot;{{ item.item.key }}&quot;
</span><span class='line'>        std_out: &quot;{{ item.stdout }}&quot;
</span><span class='line'>      connection: local
</span><span class='line'>      when: item.stdout is defined
</span><span class='line'>      with_items: trace_result.results
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;Test verification&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Finally we need to compare the captured output with the scenario steps. This time all the information collected by Ansible in the previous tasks needs to be passed to a module.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span><span class='line'>&lt;code&gt;yaml ~/tdd_ansible/cisco_tdd.yml
</span><span class='line'>    - name: verify traceroutes against pre-defined scenarios
</span><span class='line'>      cisco_tdd_verify:
</span><span class='line'>        dest_host: &quot;{{ item.key }}&quot;
</span><span class='line'>        src_host: &quot;{{ inventory_hostname }}&quot;
</span><span class='line'>        scenario: &quot;{{ scenario_steps }}&quot;
</span><span class='line'>        ip2host: &quot;{{ ip2host }}&quot;
</span><span class='line'>        path: &quot;{{ hostvars[inventory_hostname][item.key] }}&quot;
</span><span class='line'>        scenario_name: &quot;{{ scenario_name }}&quot;
</span><span class='line'>      when: scenario_steps[inventory_hostname] is defined
</span><span class='line'>      with_dict: scenario_steps[inventory_hostname]|default({})
</span><span class='line'>      connection: local
</span><span class='line'>&lt;/code&gt;
</span><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Ansible module contains a class with a single public method &lt;code&gt;compare&lt;/code&gt;. The first thing it does is converts the list of IP addresses of transit devices into a list of hostnames. That&amp;rsquo;s where the IP-to-Hostname dictionary created in the &lt;a href=&quot;http://networkop.github.io/blog/2015/07/03/parser-modules/&quot;&gt;previous playbook&lt;/a&gt; is first used. IP address is used as a lookup key and the Hostname is extracted from the first element of the returned list (second element, the interface name, is currently unused). The private method &lt;code&gt;__validatepath&lt;/code&gt; is used to confirm that devices listed after &lt;code&gt;Via&lt;/code&gt; in a test scenario are present in the traceroute path in the specified order. If this verification fails, the whole module fails and the error message is passed back to Ansible playbook.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/library/cisco_tdd_verify.py </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">ResultCompare</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">pre</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;dest_host&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">src_host</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;src_host&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">trace_path</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;path&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">ref_scenario</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;scenario&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">ip2host</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;ip2host&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="bp">self</span><span class="o">.</span><span class="n">scenario_name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="o">&amp;</span><span class="c">#39;scenario_name&amp;#39;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">trace_path_new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace_path</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="k">if</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip2host</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">trace_path_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip2host</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">trace_path_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_scenario</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_scenario</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_host</span><span class="p">]:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">ref_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_scenario</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_host</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span><span class="p">]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span> <span class="n">__validatepath</span><span class="p">(</span><span class="n">trace_path_new</span><span class="p">):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>                <span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Failed</span> <span class="n">scenario</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_name</span> <span class="o">+</span>  <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">.</span>\<span class="n">r</span>\<span class="n">nTraceroute</span> <span class="kn">from</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_host</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="n">to</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span> <span class="o">+</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">traversed</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_path</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>                <span class="n">msg</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>\<span class="n">r</span>\<span class="n">n</span> <span class="n">Actual</span> <span class="n">path</span> <span class="n">taken</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">+</span> <span class="o">&amp;</span><span class="c">#39; -&amp;amp;gt; &amp;#39;.join([self.src_host] + trace_path_new) + &amp;quot;\r\n&amp;quot;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="c">#39;no error&amp;#39;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">__validatepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_scenario</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_host</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_scenario</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_host</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_host</span><span class="p">]):</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>                <span class="k">return</span> <span class="bp">True</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">return</span> <span class="bp">False</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">code</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">pre</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="n">argument_spec</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">dest_host</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">src_host</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">scenario</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">dict</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">ip2host</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">dict</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">path</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">list</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>            <span class="n">scenario_name</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">rsquo</span><span class="p">;)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">comparator</span> <span class="o">=</span> <span class="n">ResultCompare</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="n">rc</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">comparator</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>        <span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">p</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span><span class="n">main</span><span class="p">()</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s">&#39;line&#39;</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;TDD in action&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;So let&amp;rsquo;s finally see the whole thing action. First let&amp;rsquo;s modify a &lt;a href=&quot;http://networkop.github.io/blog/2015/06/17/dev-env-setup/&quot;&gt;4-router topology&lt;/a&gt; so that traffic from R1 to R4 is routed via R2 and R3 (a simple &lt;code&gt;delay 9999&lt;/code&gt; on Ethernet0/1 will do). Now let&amp;rsquo;s run the first scenario and verify that no errors are displayed.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>Scenario 1 successful </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;~/tdd_ansible# ansible-playbook cisco_tdd.yml
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;Enter scenario number <span class="o">[</span>1<span class="o">]</span>:<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>PLAY <span class="o">[</span>Run traceroute commands<span class="o">]</span> <span class="p">&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>amp<span class="p">;</span>hellip<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;PLAY RECAP <span class="p">&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;</span>********************
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R1                         : <span class="nv">ok</span><span class="o">=</span><span class="m">4</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R2                         : <span class="nv">ok</span><span class="o">=</span><span class="m">4</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R3                         : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R4                         : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span></code></pre></td></tr></table></div></figure>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Nothing much really, which is good, that means all scenarios were verified successfully. Now let&amp;rsquo;s see how it fails. The easiest way is to run the tests from a second scenario, the one that assumes that the link between R1 and R2 failed and all the traffic is routed via R4.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>Scenario 2 failed </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;~/tdd_ansible# ansible-playbook cisco_tdd.yml
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;Enter scenario number <span class="o">[</span>1<span class="o">]</span>: 2<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>PLAY <span class="o">[</span>Run traceroute commands<span class="o">]</span> <span class="p">&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;</span>**************************
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>amp<span class="p">;</span>hellip<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;TASK: <span class="o">[</span>verify traceroutes against pre-defined scenarios<span class="o">]</span> <span class="p">&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;skipping: <span class="o">[</span>R2<span class="o">]</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;skipping: <span class="o">[</span>R4<span class="o">]</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;failed: <span class="o">[</span>R1<span class="o">]</span> <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> <span class="o">(</span><span class="nv">item</span><span class="o">={</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>key<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>: <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R2<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>value<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>: <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R3<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span><span class="o">]})</span> <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> <span class="o">{</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>failed<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="nb">true</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>item<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="o">{</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>key<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R2<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>value<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R3<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span><span class="o">]}}</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;msg: Failed scenario Testing of Backup Link.
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;Traceroute from R1 to R2 has not traversed <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R3<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span><span class="o">]</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt; Actual path taken: R1 -<span class="p">&amp;</span>gt<span class="p">;</span> R2<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>failed: <span class="o">[</span>R3<span class="o">]</span> <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> <span class="o">(</span><span class="nv">item</span><span class="o">={</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>key<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>: <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R1<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>value<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>: <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span><span class="o">]})</span> <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> <span class="o">{</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>failed<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="nb">true</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>item<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="o">{</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>key<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R1<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>value<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span><span class="o">]}}</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;msg: Failed scenario Testing of Backup Link.
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;Traceroute from R3 to R1 has not traversed <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span><span class="o">]</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt; Actual path taken: R3 -<span class="p">&amp;</span>gt<span class="p">;</span> R2 -<span class="p">&amp;</span>gt<span class="p">;</span> R1<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>failed: <span class="o">[</span>R1<span class="o">]</span> <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> <span class="o">(</span><span class="nv">item</span><span class="o">={</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>key<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>: <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R3<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>value<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span>: <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span><span class="o">]})</span> <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> <span class="o">{</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>failed<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="nb">true</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>item<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="o">{</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>key<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R3<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>, <span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>value<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span>: <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>ldquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rdquo<span class="p">;</span><span class="o">]}}</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;msg: Failed scenario Testing of Backup Link.
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;Traceroute from R1 to R3 has not traversed <span class="o">[</span><span class="p">&amp;</span>amp<span class="p">;</span>lsquo<span class="p">;</span>R4<span class="p">&amp;</span>amp<span class="p">;</span>rsquo<span class="p">;</span><span class="o">]</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt; Actual path taken: R1 -<span class="p">&amp;</span>gt<span class="p">;</span> R2 -<span class="p">&amp;</span>gt<span class="p">;</span> R3<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>PLAY RECAP ********************************************************************
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;           to retry, use: <span class="p">&amp;</span>amp<span class="p">;</span>ndash<span class="p">;</span>limit @/root/cisco_tdd.retry<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>R1                         : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>1
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R2                         : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R3                         : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>1
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R4                         : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span></code></pre></td></tr></table></div></figure>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Here all 3 test steps within a scenario failed. Ansible displayed error messages passed down by our module, specifying the expected and the actual path.&lt;br/&gt;
</span><span class='line'>Now if we simply shutdown Ethernet0/0 of R1 to simulate a link failure and re-run the same scenario all tests will succeed again.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>Scenario 2 successful </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;~/tdd_ansible# ansible-playbook cisco_tdd.yml
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;Enter scenario number <span class="o">[</span>1<span class="o">]</span>: 2<span class="p">&amp;</span>lt<span class="p">;</span>/p<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>lt<span class="p">;</span>p<span class="p">&amp;</span>gt<span class="p">;</span>PLAY <span class="o">[</span>Run traceroute commands<span class="o">]</span> <span class="p">&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>strong<span class="p">&amp;</span>gt<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;<span class="p">&amp;</span>amp<span class="p">;</span>hellip<span class="p">;</span>
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;PLAY RECAP <span class="p">&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;&amp;</span>lt<span class="p">;</span>/strong<span class="p">&amp;</span>gt<span class="p">;</span>********************
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R1                         : <span class="nv">ok</span><span class="o">=</span><span class="m">4</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R2                         : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R3                         : <span class="nv">ok</span><span class="o">=</span><span class="m">4</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;R4                         : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>&lt;/span&gt;&lt;span <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;line&#39;</span>&gt;
</span></code></pre></td></tr></table></div></figure>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;So there it is, a working network TDD framework in action. I still haven&amp;rsquo;t covered a lot of corner cases (e.g. when traceroute times out) and deployment scenarios (device with VRFs) but it should still work for a lot of scenarios and can be easily extended to cover those corner cases.&lt;/p&gt;
</span><span class='line'>]]&gt;&lt;/content&gt;
</span><span class='line'>  &lt;/entry&gt;
</span><span class='line'>
</span><span class='line'>  &lt;entry&gt;
</span><span class='line'>    &lt;title type=&quot;html&quot;&gt;&lt;![CDATA[IP Address Information Collection With Custom Ansible Modules]]&gt;&lt;/title&gt;
</span><span class='line'>    &lt;link href=&quot;http://networkop.github.io/blog/2015/07/03/parser-modules/&quot;/&gt;
</span><span class='line'>    &lt;updated&gt;2015-07-03T00:00:00-07:00&lt;/updated&gt;
</span><span class='line'>    &lt;id&gt;http://networkop.github.io/blog/2015/07/03/parser-modules&lt;/id&gt;
</span><span class='line'>    &lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;p&gt;Ansible has a very neat feature called &amp;ldquo;fact gathering&amp;rdquo;, which collects useful information from hosts prior to executing any of the tasks and makes this information available for use within those tasks. Unfortunately, this also relies on Python being available on the remote machine which doesn&amp;rsquo;t work for Cisco IOS. In this post I&amp;rsquo;ll show how to write a simple module which will collect IP address information from remote devices and store it in global variable for future use. I&amp;rsquo;ll also show how to write a module which will convert our human-readable TDD scenarios into YAML structures. As always, full code repository is available on &lt;a href=&quot;https://github.com/networkop/simple-cisco-tdd&quot;&gt;Github&lt;/a&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;!--more--&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;Cisco IOS IP fact gathering&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;In order to recognise that a traceroute has traversed a certain device, without relying on DNS, we need to populate a local database mapping IP addresses to their respective devices. The resulting database (or YAML dictionary) needs to be stored in a file so that it can be read and used again by Ansible tasks doing the traceroute verification. In order to make it happen, we need to answer the following questions:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;How to get IP address information from each device?&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;blockquote&gt;&lt;p&gt;The most straight-forward way is to capture the result of running something like &lt;code&gt;show ip interface brief&lt;/code&gt; and parse the output. The assumption is that all devices are living in a non-overlapping IP address space (however it is possible to modify the examples to be vrf-aware).&lt;/p&gt;&lt;/blockquote&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;Where to store the information?&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;blockquote&gt;&lt;p&gt;Ideally, we would need a hash-like data structure (e.g. python dictionary) which will return a hostname when given a certain IP address. This data structure needs to be available to all hosts, however most of the variables in Ansible are host-specific. The only way to simulate a global variable in Ansible is to store all data in &lt;code&gt;group_vars/all.yml&lt;/code&gt; file which is exactly what our module will do.&lt;/p&gt;&lt;/blockquote&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;How will multiple processes write into a single file at the same time?&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;blockquote&gt;&lt;p&gt;That&amp;rsquo;s where Ansible&amp;rsquo;s concurrency feature bites back. This is a well known computer science problem and the solution to this is to use &lt;code&gt;mutex&lt;/code&gt;, however that&amp;rsquo;s beyond what Ansible can do. In order to overcome that, I&amp;rsquo;ll make Ansible do the tasks sequentially, which will dramatically slow things down for bigger environments. However, this task only needs to be run once, to collect the data, while all the other tasks can be run in parallel, in separate playbooks.&lt;/p&gt;&lt;/blockquote&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;Developing Ansible playbook&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Our Ansible playbook will need to accomplish the following tasks:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ol&gt;
</span><span class='line'>&lt;li&gt;Capture the output &lt;code&gt;show ip interface brief&lt;/code&gt; command&lt;/li&gt;
</span><span class='line'>&lt;li&gt;Parse the output capture in the previous step&lt;/li&gt;
</span><span class='line'>&lt;li&gt;Save the output in a &lt;code&gt;group_vars/all.yml&lt;/code&gt; file&lt;/li&gt;
</span><span class='line'>&lt;/ol&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;All these tasks will need to be run sequentially on every host from &lt;code&gt;cisco-devices&lt;/code&gt; group. To get the output from a Cisco device we&amp;rsquo;ll use the &lt;code&gt;raw&lt;/code&gt; module again. The other two tasks don&amp;rsquo;t require connection to remote device and will be run on a localhost by the virtue of a &lt;code&gt;delegate_to: 127.0.0.1&lt;/code&gt; option.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;``` yaml ~/tdd_ansible/cisco-ip-collect.yml&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;&lt;p&gt;name: Collect IP address data
</span><span class='line'>hosts: cisco-devices
</span><span class='line'>gather_facts: false
</span><span class='line'>remote_user: cisco
</span><span class='line'>serial: 1&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tasks:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;&lt;p&gt;name: capture show ip interface brief
</span><span class='line'>raw: show ip interface brief | exclude unassigned
</span><span class='line'>register: siib_text&lt;/p&gt;&lt;/li&gt;
</span><span class='line'>&lt;li&gt;&lt;p&gt;name: parse the output of &amp;ldquo;show ip interface brief&amp;rdquo;
</span><span class='line'>cisco_ip_intf_facts_collect: output_text=&amp;ldquo;{{ siib_text.stdout }}&amp;rdquo;
</span><span class='line'>delegate_to: 127.0.0.1&lt;/p&gt;&lt;/li&gt;
</span><span class='line'>&lt;li&gt;&lt;p&gt;name: combine ip address facts and save as a global variable
</span><span class='line'>cisco_ip_intf_facts_combine:
</span><span class='line'>  ipTable=&amp;ldquo;{{ IPs }}&amp;rdquo;
</span><span class='line'>  hostname=&amp;ldquo;{{ inventory_hostname }}&amp;rdquo;
</span><span class='line'>delegate_to: 127.0.0.1&lt;/p&gt;&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tags:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;collect
</span></code></pre></td></tr></table></div></figure></notextile></div>
</li>
</ul>
</li>
</ul>


<h2>Writing a custom Ansible module</h2>

<p>Ansible has an <a href="http://docs.ansible.com/developing_modules.html">official guide</a> on module development. A typical module will contain a header with license information along with module documentation and usage examples, a <code>main()</code> function processing the arguments passed to this module from Ansible and, of course, the actual code that implements module&rsquo;s logic. For the sake of brevity I will omit the header and some of the less important details in the code.</p>

<h2>Ansible module to parse command output</h2>

<p>This ansible module needs to extract IP address and, optionally, interface name from the output of <code>show ip interface brief</code> and store it in a python dictionary. The right way to examine the module code is from <code>main()</code> function. This function will contain a <code>module</code> variable (instance of AnsibleModule) which specifies all the arguments expected by this module and their type (the type will be converted to the appropriate python type). Text parser is implemented with a <code>SIIBparse</code> class whose only public method <code>parse()</code> will traverse the text line by line looking for interfaces with Line Protocol in <code>up</code> state, extract IP address (1st column), interface name (2nd column) and store the result in a python dictionary with IP address as the key and interface name as it&rsquo;s value.</p>

<p><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/library/cisco_ip_intf_facts_collect.py </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">SIIBparse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">output_text</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;output_text&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;up&#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">ipAddress</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>            <span class="n">intfName</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span><span class="p">[</span><span class="n">ipAddress</span><span class="p">]</span> <span class="o">=</span> <span class="n">intfName</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;IPs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">rc</span><span class="p">,</span> <span class="n">result</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span>
</span><span class='line'>        <span class="n">argument_spec</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="n">output_text</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">siib</span> <span class="o">=</span> <span class="n">SIIBparse</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span><span class='line'>    <span class="n">rc</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">siib</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">parse</span><span class="o">.</span> <span class="n">Incorrect</span> <span class="nb">input</span><span class="o">.&amp;</span><span class="n">rdquo</span><span class="p">;)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ansible_facts</span><span class="o">=</span><span class="n">result</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">module</span> <span class="nn">snippets</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>If information passed to the module in the argument was invalid, the module must fail with a meaningful message passed inside a <code>fail_json</code> method call. When parsing is complete, our module exits and the resulting data structure is passed back to Ansible variables with <code>ansible_facts</code> argument. Now all hosts can access it through variable called <code>IPs</code>.</p>

<h2>Ansible module to save IP address information</h2>

<p>The task of this module is to get all the information collected inside each hosts' <code>IPs</code> variables, combine it with devices' hostnames and save it in the <code>group_vars/all.yml</code> file. This module makes use of <a href="http://pyyaml.org/wiki/PyYAMLDocumentation">Python&rsquo;s yaml library</a>. Built-in class <code>FactUpdater</code> can read(), update() the contents and write() the global variable file defined in a <code>FILENAME</code> variable.</p>

<p><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/library/cisco_ip_intf_facts_combine.py </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">yaml</span>
</span><span class='line'><span class="n">FILENAME</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">group_vars</span><span class="o">/</span><span class="nb">all</span><span class="o">.</span><span class="n">yml</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">FactUpdater</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;ipTable&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;hostname&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;ip2host&#39;</span><span class="p">:{}}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileObj</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileObj</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># in case there is no file - create it</span>
</span><span class='line'>        <span class="nb">open</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileObj</span><span class="p">:</span>
</span><span class='line'>        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_content</span><span class="p">,</span> <span class="n">fileObj</span><span class="p">,</span> <span class="n">explicit_start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">allow_unicode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;ip2host&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span><span class="p">[</span><span class="s">&#39;ip2host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span><span class="p">[</span><span class="s">&#39;ip2host&#39;</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip2intf</span><span class="p">[</span><span class="n">ip</span><span class="p">]]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span>
</span><span class='line'>        <span class="n">argument_spec</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
</span><span class='line'>            <span class="n">ipTable</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">dict</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'>            <span class="n">hostname</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">str</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span>
</span><span class='line'>    <span class="n">factUpdater</span> <span class="o">=</span> <span class="n">FactUpdater</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">factUpdater</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>        <span class="n">factUpdater</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span class='line'>        <span class="n">factUpdater</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Unexpected</span> <span class="n">error</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">module</span> <span class="nn">snippets</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>This module only performs actions on local file and does not provide any output back to Ansible.</p>

<h2>Read and parse TDD scenarios</h2>

<p>Finally, since we&rsquo;re modifying Ansible global variable file, it would make sense to also update it with testing scenarios information. Technically, this steps doesn&rsquo;t need to be done in Ansible and could be done simply using Python or Bash scripts, but I&rsquo;ll still show it here to demonstrate two additional Ansible features. The first one is <code>local_action: module_name</code> which is a shorthand for specifying <code>module</code> with <code>delegate_to</code> option (see above). Second feature is <code>tags</code>, it allows to specify which play to run in playbook containing many of them. In our case one file <code>cisco-ip-collect.yml</code> will have two plays defined and will run both of them by default unless <code>--tag=scenario</code> or <code>--tag=collect</code> specifies the exact play.</p>

<p>
<figure class='code'><figcaption><span>~/tdd_ansible/cisco-ip-collect.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Parse and save scenarios</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;  tasks:&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;pre&gt;&lt;code&gt;- name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">parse scenario file and save it in group_vars/all.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cisco_scenarios_convert</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;  tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">scenario</span>
</span></code></pre></td></tr></table></div></figure>
</p>

<p>This play has a single task which runs a single custom module. Before we proceed to the module let&rsquo;s see how a typical testing scenario file looks like.</p>

<p><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/scenarios/all.txt </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>1. Testing of Primary Link
</span><span class='line'>1.1 From R1 to R3 via R2
</span><span class='line'>1.2 From R1 to R4 via R2, R3
</span><span class='line'>2. Testing of Backup Link
</span><span class='line'>2.1 From R1 to R3 via R4
</span><span class='line'>2.2 From R1 to R2 via R4,R3
</span></code></pre></td></tr></table></div></figure></p>

<p>The file should be stored in a <code>scenarios/</code> directory and should have a name <code>all.txt</code>. This file contains a list of scenarios, each with its own name, and a list of test steps that need to be performed to validate a particular scenario. The parser for this file is a custom Python module which opens and reads the contents of <code>group_vars/all.yml</code> file, parses the scenarios file with the help of some ugly-looking regular expressions, and, finally, updates and saves the contents of Ansible group variable back to file.</p>

<p><figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'>~/tdd_ansible/library/cisco_scenarios_convert.py </h3></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">yaml</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="n">SCENARIO_FILE</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">scenarios</span><span class="o">/</span><span class="nb">all</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="n">GROUP_VAR_FILE</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">group_vars</span><span class="o">/</span><span class="nb">all</span><span class="o">.</span><span class="n">yml</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">class</span> <span class="nc">ScenarioParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>   <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">GROUP_VAR_FILE</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileObj</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileObj</span><span class="p">)</span>
</span><span class='line'>   <span class="k">except</span><span class="p">:</span>
</span><span class='line'>       <span class="nb">open</span><span class="p">(</span><span class="n">GROUP_VAR_FILE</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="n">scenario_number</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">scenario_step</span>   <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="n">scenario_name</span>   <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>    <span class="n">name_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(\d+)\.?\s+(.*)&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">step_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;.*[Ff][Rr][Oo][Mm]\s+([\d\w]+)\s+[Tt][Oo]\s+([\d\w]+)\s+[Vv][Ii][Aa]\s+([\d\w]+,*\s*[\d\w]+)*&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SCENARIO_FILE</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileObj</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileObj</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">3</span><span class="p">:</span>
</span><span class='line'>                <span class="n">name_match</span> <span class="o">=</span> <span class="n">name_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>                <span class="n">step_match</span> <span class="o">=</span> <span class="n">step_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">name_match</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">scenario_number</span> <span class="o">=</span> <span class="n">name_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">scenario_name</span>   <span class="o">=</span> <span class="n">name_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">scenario_steps</span>  <span class="o">=</span> <span class="p">[</span><span class="n">scenario_name</span><span class="p">,</span> <span class="p">{}]</span>
</span><span class='line'>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">:</span>
</span><span class='line'>                        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="n">scenario_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_steps</span>
</span><span class='line'>                    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                        <span class="n">scenario_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="n">scenario_number</span><span class="p">]</span>
</span><span class='line'>                <span class="k">elif</span> <span class="n">step_match</span><span class="p">:</span>
</span><span class='line'>                    <span class="n">from_device</span> <span class="o">=</span> <span class="n">step_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">to_device</span> <span class="o">=</span> <span class="n">step_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">via</span> <span class="o">=</span> <span class="n">step_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">via_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">device_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">device_name</span> <span class="ow">in</span> <span class="n">via</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
</span><span class='line'>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario_number</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">scenario_name</span><span class="p">:</span>
</span><span class='line'>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_device</span> <span class="ow">in</span> <span class="n">scenario_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span class='line'>                            <span class="n">scenario_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">from_device</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span class='line'>                        <span class="n">scenario_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">from_device</span><span class="p">][</span><span class="n">to_device</span><span class="p">]</span> <span class="o">=</span> <span class="n">via_devices</span>
</span><span class='line'>                <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>   <span class="bp">self</span><span class="o">.</span><span class="n">file_content</span><span class="p">[</span><span class="s">&#39;scenarios&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span>
</span><span class='line'>   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">GROUP_VAR_FILE</span><span class="p">,</span> <span class="s">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileObj</span><span class="p">:</span>
</span><span class='line'>           <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_content</span><span class="p">,</span> <span class="n">fileObj</span><span class="p">,</span> <span class="n">explicit_start</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">allow_unicode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span><span class="n">argument_spec</span><span class="o">=</span><span class="nb">dict</span><span class="p">())</span>
</span><span class='line'>    <span class="n">parser</span> <span class="o">=</span> <span class="n">ScenarioParser</span><span class="p">()</span>
</span><span class='line'>    <span class="n">parser</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</span><span class='line'>    <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="o">.</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">parse</span><span class="o">.</span> <span class="n">Incorrect</span> <span class="nb">input</span><span class="o">.&amp;</span><span class="n">rdquo</span><span class="p">;)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The biggest portion of code is the read() method of the parser which does the following:</p>

<ul>
<li>scans text file line by line ignoring lines starting with <code>#</code> and whose length is not enough to contain either a scenario name or scenario step</li>
<li>matches each line against pre-compiled regular expressions for scenario name or for scenario step (<a href="https://regex101.com/">a very helpful tool for regex testing</a>)</li>
<li>attempts to save the data in a Python dictionary whose keys are scenario numbers and whose values is a list consisting of a scenario name (1st element) and a dictionary with scenario steps (2nd element)</li>
</ul>


<p>The end result of running both ip address collection and scenarios conversion plays is Ansible group variable file that looks like this:</p>

<p></p>

<h2>``` yaml  ~/tdd_ansible/library/group_vars/all.yml</h2>

<p>ip2host:
   10.0.0.1: [R1, Loopback0]
   10.0.0.2: [R2, Loopback0]
   10.0.0.3: [R3, Loopback0]
   10.0.0.4: [R4, Loopback0]
   12.12.12.1: [R1, Ethernet0/0]
   12.12.12.2: [R2, Ethernet0/0]
   14.14.14.1: [R1, Ethernet0/1]
   14.14.14.4: [R4, Ethernet0/1]
   192.168.247.25: [R1, Ethernet0/2]
   23.23.23.2: [R3, Ethernet0/0]
   34.34.34.3: [R3, Ethernet0/1]
   34.34.34.4: [R4, Ethernet0/0]
scenarios:
   &lsquo;1&rsquo;:
   - Testing of Primary Link
   -  R1:
         R2: [R2]
         R3: [R2]
         R4: [R2, R3]
      R2:
         R4: [R3]
   &lsquo;2&rsquo;:
   - Testing of Backup Link
   -  R1:
         R2: [R4, R3]
         R3: [R4]
      R3:
         R1: [R4]
<figure class='code'><figcaption><span>~/tdd_ansible/cisco-ip-collect.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">{</span><span class="err">%</span> <span class="nv">endraw  %</span><span class="p-Indicator">}</span><span class="l-Scalar-Plain">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;hr /&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;The next post, final in a series, will show how to write an Ansible play to validate TDD scenarios and produce a meaningful error message in case it fails.&lt;/p&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">]]&gt;&lt;/content&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">&lt;/entry&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">&lt;entry&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&lt;title type=&quot;html&quot;&gt;&lt;![CDATA[Getting Started With Ansible for Cisco IOS]]&gt;&lt;/title&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&lt;link href=&quot;http://networkop.github.io/blog/2015/06/24/ansible-intro/&quot;/&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&lt;updated&gt;2015-06-24T00:00:00-07:00&lt;/updated&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&lt;id&gt;http://networkop.github.io/blog/2015/06/24/ansible-intro&lt;/id&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&lt;content type=&quot;html&quot;&gt;&lt;![CDATA[&lt;p&gt;Ansible is well-known for it&amp;rsquo;s low entry threshold. All what&amp;rsquo;s required to get started is just one inventory file. However Cisco IOS devices require special considerations.</span>
</span><span class='line'><span class="l-Scalar-Plain">Passwordless SSH RSA-based authentication is still a novelty and in most cases users are authenticated based on their passwords. Another problem is the lack of Python execution</span>
</span><span class='line'><span class="l-Scalar-Plain">environment on IOS devices, which seriously limits the choice of Ansible modules that can be used. In this post I will show how to setup Ansible</span>
</span><span class='line'><span class="l-Scalar-Plain">environment to control Cisco IOS devices&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;!--more--&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;h2&gt;Ansible overview&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;There&amp;rsquo;s been a lot written about what Ansible is and what it was built to accomplish. I will just provide a brief summary of its features focusing on what we&amp;rsquo;re gonna be using it for, leaving an in-depth explanation to the official &lt;a href=&quot;http://docs.ansible.com/&quot;&gt;Ansible documentation&lt;/a&gt;.&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;ul&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;What is it?&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/ul&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;blockquote&gt;&lt;p&gt;Ansible is an IT automation and orchestration framework&lt;/p&gt;&lt;/blockquote&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;ul&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;What was it built to accomplish?&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/ul&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;blockquote&gt;&lt;p&gt;Ansible was designed to automate routine tasks like server/application deployment and configuration&lt;/p&gt;&lt;/blockquote&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;ul&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;How does it work?&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/ul&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;blockquote&gt;&lt;p&gt;It connects to several hosts at the same time and executes small programs called &amp;ldquo;modules&amp;rdquo; in the order specified in a file called &amp;ldquo;playbook&amp;rdquo;&lt;/p&gt;&lt;/blockquote&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;To build what we&amp;rsquo;ve set out to accomplish I&amp;rsquo;m gonna be using the latter feature. I am not gonna be using Ansible for system provisioning or service orchestration. Instead, I will be exploiting Ansible&amp;rsquo;s ability to run multiple parallel connections to remote hosts, execute commands on them and return their result. Due to that, I will diverge from some of the &lt;a href=&quot;https://docs.ansible.com/playbooks_best_practices.html&quot;&gt;Ansible&amp;rsquo;s best practices&lt;/a&gt; of splitting functions into roles and I will use one flat playbook file segregating different functions with tags.&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;h2&gt;Ansible configuration file&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;Ansible configuration file &lt;code&gt;ansible.cfg&lt;/code&gt; contains &lt;a href=&quot;http://docs.ansible.com/intro_configuration.html&quot;&gt;application-wide settings&lt;/a&gt; like default timeouts, port numbers and other flags. The default Ansible configuration file is located in &lt;code&gt;/etc/ansible/&lt;/code&gt; directory. However, instead of overwriting the defaults it is possible to create a configuration file in a local directory with only the settings that need to be overridden. To better work with Cisco devices the following settings will need to be modified:&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;ul&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;Default SSH library (transport) needs to be set to &lt;code&gt;paramiko&lt;/code&gt; which is more stable than its alternative, OpenSSH, when working with Cisco IOS.&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;For a small project it is easier to maintain a local copy of inventory file which is configured with &lt;code&gt;hostfile&lt;/code&gt; setting.&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;Strict SSH key checking is a MUST in every production environment, however, for development environment an exception can be made.&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;li&gt;Default SSH timeout is decreased to 5 seconds reflecting a small size of the testing environment.&lt;/li&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/ul&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;&lt;code&gt;bash ~/tdd_ansible/ansible.cfg</span>
</span><span class='line'><span class="l-Scalar-Plain">[defaults]</span>
</span><span class='line'><span class="l-Scalar-Plain">transport=paramiko</span>
</span><span class='line'><span class="l-Scalar-Plain">hostfile = ./myhosts</span>
</span><span class='line'><span class="l-Scalar-Plain">host_key_checking=False</span>
</span><span class='line'><span class="l-Scalar-Plain">timeout = 5</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/code&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;h2&gt;Inventory file&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;Inventory contains the list of hosts to be managed by Ansible. Hosts are normally combined into groups (&lt;code&gt;cisco-devices&lt;/code&gt; in our case) and Ansible performs actions on all hosts in the group in parallel.&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;&lt;code&gt;bash ~/tdd_ansible/myhosts</span>
</span><span class='line'><span class="l-Scalar-Plain">[cisco-devices]</span>
</span><span class='line'><span class="l-Scalar-Plain">R1</span>
</span><span class='line'><span class="l-Scalar-Plain">R2</span>
</span><span class='line'><span class="l-Scalar-Plain">R3</span>
</span><span class='line'><span class="l-Scalar-Plain">R4</span>
</span><span class='line'><span class="l-Scalar-Plain">&lt;/code&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">It is considered a &lt;a href=&quot;https://docs.ansible.com/playbooks_best_practices.html#group-and-host-variables&quot;&gt;best practice&lt;/a&gt; to keep all variables in separate folders and files. We need to define additional host variables to let Ansible know which IP address to use to connect to a remote device. I will also add SSH password to a host variable file which is a VERY bad practice, however this will prevent me from typing password every time I run a playbook. If I ever did this in production, I&amp;rsquo;d add host variables directory to &lt;code&gt;.gitignore&lt;/code&gt; file so that it doesn&amp;rsquo;t get uploaded to Github. Host variables files must follow YAML formatting, must be stored in a &lt;code&gt;./host_vars&lt;/code&gt; directory and must match the name of the host they are being assigned to.&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;h2&gt;``` yaml ~/tdd_ansible/host_vars/R1&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&lt;p&gt;ansible_ssh_host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10.0.0.1</span>
</span><span class='line'><span class="l-Scalar-Plain">ansible_ssh_pass</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cisco</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Similar files need to be created for R2, R3 and R4.</p>

<h2>Run a test traceroute commands</h2>

<p>Now it is time to finally see Ansible in action. Let&rsquo;s first see if we can run a standalone traceroute command. I will manually define SSH username with <code>-u</code> flag and use a module called <code>raw</code> passing traceroute command as an argument with <code>-a</code> option.</p>

<pre><code class="bash Ad-hoc traceroute command">$ ansible cisco-devices -u cisco -m raw -a "traceroute 10.0.0.4 source Loopback0 probe 1 numeric"
SSH password:
R1 | success | rc=0 &gt;&gt;

Type escape sequence to abort.
Tracing the route to 10.0.0.4
VRF info: (vrf in name/id, vrf out name/id)
  1 14.14.14.4 0 msec *  0 msec

R2 | success | rc=0 &gt;&gt;

Type escape sequence to abort.
Tracing the route to 10.0.0.4
VRF info: (vrf in name/id, vrf out name/id)
  1 12.12.12.1 0 msec 0 msec 0 msec
  2  *  *
    14.14.14.4 0 msec

R3 | success | rc=0 &gt;&gt;

Type escape sequence to abort.
Tracing the route to 10.0.0.4
VRF info: (vrf in name/id, vrf out name/id)
  1 34.34.34.4 0 msec 0 msec *

R4 | success | rc=0 &gt;&gt;

Type escape sequence to abort.
Tracing the route to 10.0.0.4
VRF info: (vrf in name/id, vrf out name/id)
  1 10.0.0.4 0 msec 0 msec *
</code></pre>

<p>Ansible ad-hoc commands are a good way to quickly test something out and learn how things work. Next step would be to create a playbook file which will contain several of those commands in a more structured way. Playbooks use YAML syntax and follow strict formatting rules. At the top of the file there&rsquo;s a name of the play along with the target hosts group. Following that are a list of tasks, each of which calls its own module and passes arguments to it. In this example playbook does the following:</p>

<ol>
<li>Defines a <code>loopbacks</code> variable which stores in a hash a list of devices along with their loopback IP addresses.</li>
<li>Uses <code>raw</code> module to run traceroute commands. This is the only module that doesn&rsquo;t require Python to be installed on a target machine.</li>
<li>For each host in <code>cisco-devices</code> group runs traceroute to every other hosts' loopback IP</li>
<li>Stores the result in a <code>trace_result</code> variable</li>
</ol>


<p>{% raw %}</p>

<h2>``` yaml ~/tdd_ansible/cisco-trace-run.yml</h2>

<ul>
<li><p>name: Run traceroute commands
hosts: cisco-devices
gather_facts: false
remote_user: cisco</p>

<p>vars:
  loopbacks: {
  &ldquo;R1&rdquo;: &ldquo;10.0.0.1&rdquo;,
  &ldquo;R2&rdquo;: &ldquo;10.0.0.2&rdquo;,
  &ldquo;R3&rdquo;: &ldquo;10.0.0.3&rdquo;,
  &ldquo;R4&rdquo;: &ldquo;10.0.0.4&rdquo;,
  }</p>

<p>tasks:</p>

<ul>
<li>name: run traceroute to every other host
raw: traceroute {{ item.value }} source Loopback0 probe 1 numeric
when: item.key != inventory_hostname
with_dict: loopbacks
register: trace_result</li>
</ul>
</li>
</ul>


<h1>- name: Debug registered variables</h1>

<h1>debug: var=trace_result</h1>

<pre><code>

In this Playbook I use several useful Ansible features:

* [Variables defined in playbooks](https://docs.ansible.com/playbooks_variables.html#variables-defined-in-a-playbook)
* [Looping over hashes](https://docs.ansible.com/playbooks_loops.html#looping-over-hashes)
* [Conditionals](https://docs.ansible.com/playbooks_conditionals.html)
* [Registered variables](https://docs.ansible.com/playbooks_variables.html#registered-variables)

The end result of this task is that traceroute is run 12 times - one time from each of the hosts to each other host except for when source and destination are equal.
</code></pre>

<p>$ ansible-playbook cisco-trace-run.yml</p>

<p>PLAY [Run traceroute commands] ************************************************</p>

<p>TASK: [run traceroute to every other host] ************************************
skipping: [R4] => (item={&lsquo;key&rsquo;: &lsquo;R4&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.4&rsquo;})
ok: [R1] => (item={&lsquo;key&rsquo;: &lsquo;R4&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.4&rsquo;})
skipping: [R1] => (item={&lsquo;key&rsquo;: &lsquo;R1&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.1&rsquo;})
ok: [R3] => (item={&lsquo;key&rsquo;: &lsquo;R4&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.4&rsquo;})
ok: [R4] => (item={&lsquo;key&rsquo;: &lsquo;R1&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.1&rsquo;})
ok: [R1] => (item={&lsquo;key&rsquo;: &lsquo;R2&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.2&rsquo;})
ok: [R3] => (item={&lsquo;key&rsquo;: &lsquo;R1&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.1&rsquo;})
ok: [R1] => (item={&lsquo;key&rsquo;: &lsquo;R3&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.3&rsquo;})
ok: [R3] => (item={&lsquo;key&rsquo;: &lsquo;R2&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.2&rsquo;})
skipping: [R3] => (item={&lsquo;key&rsquo;: &lsquo;R3&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.3&rsquo;})
ok: [R2] => (item={&lsquo;key&rsquo;: &lsquo;R4&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.4&rsquo;})
ok: [R2] => (item={&lsquo;key&rsquo;: &lsquo;R1&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.1&rsquo;})
skipping: [R2] => (item={&lsquo;key&rsquo;: &lsquo;R2&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.2&rsquo;})
ok: [R4] => (item={&lsquo;key&rsquo;: &lsquo;R2&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.2&rsquo;})
ok: [R2] => (item={&lsquo;key&rsquo;: &lsquo;R3&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.3&rsquo;})
ok: [R4] => (item={&lsquo;key&rsquo;: &lsquo;R3&rsquo;, &lsquo;value&rsquo;: &lsquo;10.0.0.3&rsquo;})</p>

<p>PLAY RECAP ********************************************************************
R1                         : ok=1    changed=0    unreachable=0    failed=0
R2                         : ok=1    changed=0    unreachable=0    failed=0
R3                         : ok=1    changed=0    unreachable=0    failed=0
R4                         : ok=1    changed=0    unreachable=0    failed=0</p>

<p>```</p>

<p>The above shows that all 12 tasks were completed successfully, meaning the command was executed and result was stored in a registered variable. To view the actual output of <code>traceroute</code> commands uncomment the two debug lines at the end of the playbook and rerun it.</p>

<hr />

<p>Now that the goal of running commands on multiple devices in parallel is achieved, the next step would be to decide how to make use of the received output. In the next posts I will attempt to tackle the following problems:</p>

<ul>
<li>Parse textual output of traceroute command and extract transit IP addresses.</li>
<li>Find a way to convert these transit IP addresses into hostnames without relying on DNS.</li>
<li>Verify TDD scenarios against traceroute outputs and produce an intelligible result of this verification.</li>
</ul>

]]></content>
  </entry>
  
</feed>
